## 실행 컨텍스트(1)

자바스크립트 엔진은 코드를 실행하기 위해서 **실행에 필요한 여러가지 정보들을 알고 있어야 합니다.**

예를 들면 **변수(전역 변수, 매개 변수 등)와 변수의 스코프, this**와 같은 정보들이 필요하죠.

```
실행 컨텍스트란 코드가 실행되기 위해 필요한 정보들을 가진 환경을 추상화하기 위해 객체 형태로 나타낸 것
```

<br />

---

### 소스코드의 평가와 실행

ECMAScript 사양은 소스코드(ECMAScript code)를 4가지 타입으로 구분

=> 4가지의 소스코드 타입은 4가지의 실행 컨텍스트를 생성한다.

=> **소스코드의 타입에 따라 실행 컨텍스트를 생성하는 과정과 관리 내용이 다르다.**

---

### 소스코드의 타입

1. 전역코드

   - 전역에 존재하는 소스코드

   - 최상위 스코프인 전역 스코프 생성

   - 전역 객체와 연결?

   - 전역 코드가 평가되면 전역 실행 컨텍스트가 생성된다.

2. 함수코드

   - 함수 내부에 존재하는 소스코드

   - 지역 스코프를 생성하고, 지역 변수, 매개변수, arguments 객체를 관리

   - 지역 스코프를 전역 스코프에서 시작하는 스코프 체인의 일원으로 연결해야 한다.

   - 함수 코드가 평가되면 함수 실행 컨텍스트가 생성된다.

3. eval코드

   `eval()은 문자로 표현된 자바스크립트 코드를 실행하는 함수입니다. `

   - eval 함수에 인수로 전달되어 실행되는 소스코드

   - 독자적인 스코프 생성

   - eval 코드가 평가되면 eval 실행 컨텍스트가 생성

4. 모듈코드

   - 모듈 내부에 존재하는 소스코드

   - 모듈 별로 독립적인 모듈 스코프를 생성

   - 모듈 코드가 평가되면 모듈 실행 컨텍스트가 생성된다.

<br />

---

<img width="593" alt="다운로드 (20)" src="https://github.com/yookeunbyul/cs-study/assets/91243651/0d1df248-c066-4931-a694-2cdcfb42a4ea">

이와 같이 코드 평가 과정을 거치면서 코드를 실행하기 위한 준비를 한다.

즉, 자바스크립트 엔진은 '소스코드의 평가'와 '소스코드의 실행' 과정으로 나누어 처리한다.

소스코드 평가 과정에서는 **실행 컨텍스트를 생성**하고 변수, 함수 등의 **선언문만 먼저 실행**하여 생성된 **변수나 함수 식별자를 키로, 실행 컨텍스트가 관리하는 스코프에 등록**합니다.

소스코드 평가 과정이 끝나면 비로소 **선언문을 제외한 소스코드가 순차적으로 실행**

즉, 런타임이 시작된다.

이때 실행에 필요한 정보를, **변수나 함수의 참조(주소)를 실행 컨텍스트가 관리하는 스코프에서 검색해서 취득**한다.

그리고 **소스코드의 실행 결과는 다시 실행 컨텍스트가 관리하는 스코프에 등록**된다.

<img width="592" alt="다운로드 (21)" src="https://github.com/yookeunbyul/cs-study/assets/91243651/08dc06b2-c2d8-458b-81bb-4bf02373119e">

```
코드 평가 과정 => 실행 컨텍스트(변수, 변수 스코프, this 등 정보 포함)가 생성 => 스코프에 식별자 등록 => 실행 컨텍스트 기반으로 실행(런타임) => 실행 결과를 다시 실행 컨텍스트가 관리하는 스코프에 등록
```

<br />

---

### 실행 컨텍스트의 역할

1. 선언에 의해 생성된 모든 식별자(변수, 함수, 클래스 등)를 **스코프를 구분하여 등록**하고 **상태 변화(식별자에 바인딩된 값의 변화)를 지속적으로 관리**할 수 있어야 합니다.

   => 식별자 스코프 등록하고 값의 변화를 지속적으로 관리

2. 스코프는 중첩 관계에 의해 **스코프 체인을 형성**해야 합니다.

   - 스코프 체인을 통해 상위 스코프로 이동하며 **식별자를 검색**할 수 있어야 합니다.

3. 현재 실행 중인 **코드의 실행 순서를 변경**(ex. 함수 호출에 의한 실행 순서 변경)할 수 있어야 하며, **다시 되돌아갈 수도 있어야 합니다**.

이처럼 스코프, 식별자, 코드 실행 순서 등의 관리가 필요한데 이 모든 것을 관리하는 것이 바로 실행 컨텍스트이다.

```
자바스크립트 코드를 실행시키려면 다양한 정보가 필요하다. 식별자, 스코프, this, 코드 실행 순서 등.. 이러한 코드를 실행시키는데 필요한 정보를 등록하고 지속적으로 관리하기 위해 추상화하여 객체 형태로 나타낸게 실행 컨텍스트이다?

좀 더 구체적으로 말해, 실행 컨텍스트는 식별자(변수, 함수, 클래스 등의 이름)를 등록하고 관리하는 스코프와 코드 실행 순서 관리를 구현한 내부 메커니즘으로, 모든 코드는 실행 컨텍스트를 통해 실행되고 관리됩니다.
```

<br />

---

<br />

식별자와 스코프는 **실행 컨텍스트의 렉시컬 환경**으로 관리하고, 코드 실행 순서는 **실행 컨텍스트 스택**으로 관리한다.

### 실행 컨텍스트 스택(코드 실행 순서)

자바스크립트 엔진은 먼저 전역 코드를 평가하고 전역 실행 컨텍스트를 생성하는 것, 이후 함수가 호출되면 함수 코드를 평가하여 함수 실행 컨텍스트를 생성하는 것까지 설명했었습니다.

```
전역 코드 평가 => 전역 실행 컨텍스트 생성 => 함수 코드 평가 => 함수 실행 컨텍스트 생성
```

```
const x = 1;

function foo() {
  const y = 2;

  function bar() {
  	const z = 3;
    console.log(x + y + z);
  }

  bar();
}

foo(); // 6
```

이때 평가 과정을 거치고 생성된 실행 컨텍스트(코드 실행 순서)는 **"스택" 자료구조로 관리**된다.

이를 실행 컨텍스트 스택이라고 한다.

위 코드를 실행하면 코드가 실행되는 시간의 흐름에 따라 실행 컨텍스트 스택에는 push되고 pop된다.

<img src="https://github.com/yookeunbyul/cs-study/assets/91243651/215bd892-11ec-4b99-8059-e0d1118e5b59" />

실행 컨텍스트가 생성되면 스택의 최상위에 쌓이고 최상위에 존재하는 실행 컨텍스트는 현재 **실행 중인 코드의 실행 컨텍스트**이다.

<br />

---

### 렉시컬 환경

렉시컬 환경은 **식별자와 식별자에 바인딩된 값, 그리고 상위 스코프에 대한 참조를 기록하는 자료구조**로, 실행 컨텍스트를 구성하는 컴포넌트다.

렉시컬 환경은 **키와 값을 갖는 객체 형태의 스코프를 생성**

=> **식별자를 키로 등록**하고

=> **식별자에 바인딩 된 값을 관리**한다.

==> 즉, 렉시컬 환경은 **스코프를 구분하여 식별자를 등록하고 관리하는 저장소 역할**

---

<br />

- 실행 컨텍스트는 **LexicalEnviconment 컴포넌트**와 **VariableEnvironment 컴포넌트**로 구성

  - LexicalEnviconment

    - 처음에는 VariableEnvironment와 같다.

    - 그대신 **변경사항이 실시간으로 반영**된다.

  - VariableEnvironment

    - 현재 컨텍스트 내의 식별자(변수)들에 대한 정보를 가진다.

    - 선언 시점의 LexicalEnvironment의 스냅샷을 유지한다. (변경사항 반영 ❌)

<br />

실행 컨텍스트를 생성할 때 VariableEnvironment에 정보를 먼저 담은 다음, **이를 복사해서 LexicalEnvironment를 만듭니다.**

주로 활용하는 것은 LexicalEnvironment입니다.

즉, **VariableEnviroment는 스냅샷 유지를 목적으로 사용합니다.**

---

<br />

또 LexicalEnvironment은 두 개의 컴포넌트로 구성된다.

```
실행 컨텍스트가 LexicalEnvironment 컴포넌트랑 VariableEnviroment 컴포넌트로 이루어지고,

LexicalEnvironment는 환경 레코드 컴포넌트와 외부 렉시컬 환경에 대한 참조 컴포넌트로 이루어져있다.
```

- 환경 레코드(Evironment Record)

  - 스코프에 포함된 식별자를 등록하고 등록된 식별자에 바인딩된 값을 관리하는 저장소

- 외부 렉시컬 환경에 대한 참조(Outer Lexical Environment Reference)

  - 외부 렉시컬 환경에 대한 참조는 상위 스코프를 가리킨다.

  - 상위 스코프란 상위 코드의 렉시컬 환경(실행 컨텍스트를 생성한 소스코드를 포함한)이다.

  - **외부 렉시컬 환경에 대한 참조(상위)를 통해 단방향 연결 리스트(Single Linked List)인 스코프 체인을 구현**

<br />

---

### 출처

https://east-star.tistory.com/14
